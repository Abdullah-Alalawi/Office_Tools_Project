name: Deploy to Render
on:
  push:
    branches: [main, release/*]
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: 
      name: ${{ contains(github.ref, 'release/') && 'production' || 'staging' }}
      url: ${{ steps.deploy.outputs.render-url }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'

      - name: Install and build
        run: |
          npm ci
          npm run build
        env:
          CI: false  # Prevents test runs during build

      - name: Deploy to Render
        id: deploy
        uses: render-actions/deploy@v1
        with:
          render-token: ${{ secrets.RENDER_TOKEN }}
          service-id: ${{ 
            contains(github.ref, 'release/') 
            && secrets.RENDER_PRODUCTION_SERVICE_ID 
            || secrets.RENDER_STAGING_SERVICE_ID 
          }}
          environment-vars: |
            REACT_APP_DEEPSEEK_API_KEY=${{ secrets.REACT_APP_DEEPSEEK_API_KEY }}
            REACT_APP_GPT_API_KEY=${{ secrets.REACT_APP_GPT_API_KEY }}